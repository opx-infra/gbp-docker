#!/usr/bin/env bash
set -eo pipefail

if [[ $# -gt 0 ]]; then
  if [[ ! -d "$1" ]]; then
    echo "[ERROR] $1 does not exist." >&2
    exit 1
  fi
else
  if [[ ! -e debian/control ]]; then
    echo "[ERROR] debian/control does not exist." >&2
    exit 1
  fi
fi

if [[ -n "${EXTRA_SOURCES}" ]]; then
  echo "${EXTRA_SOURCES}" | sudo tee /etc/apt/sources.list.d/20extra.list
fi

set -u

echo "deb [trusted=yes] file:///mnt ./" \
  | sudo tee /etc/apt/sources.list.d/10local.list

pushd "/mnt/" 2>/dev/null
dpkg-scanpackages -m . >Packages
popd 2>/dev/null

sudo apt-get update

dep_tool="apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y"

if [[ $# -gt 0 ]]; then
  for repo in "$@"; do
    if [[ ! -d "$repo" ]]; then
      echo "[Warning] $repo does not exist." >&2
      continue
    fi

    pushd "$repo"
    if ! mk-build-deps --install --remove --root-cmd sudo --tool "$dep_tool"; then
      echo "Error: Failed to install $repo build dependencies from:"
      tail -n +1 /etc/apt/sources.list /etc/apt/sources.list.d/*.list
      exit 1
    fi
    popd
  done
else
  if ! mk-build-deps --install --remove --root-cmd sudo --tool "$dep_tool"; then
    echo "Error: Failed to install build dependencies from these sources:"
    tail -n +1 /etc/apt/sources.list /etc/apt/sources.list.d/*.list
    exit 1
  fi
fi
